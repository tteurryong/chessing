<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>싱글마피아42 텍스트 게임</title>
<style>
  body { font-family: 'Malgun Gothic', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; }
  #game { max-width: 600px; margin: auto; }
  h1 { text-align: center; }
  button { background: #444; border: none; padding: 10px 15px; margin: 5px; color: #eee; cursor: pointer; border-radius: 5px; }
  button:hover { background: #666; }
  #messages { min-height: 180px; background: #222; padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; overflow-y: auto; max-height: 300px;}
  #players { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
  .player { background: #333; padding: 8px 12px; border-radius: 6px; cursor: pointer; user-select: none; }
  .player.alive { background: #28a745; }
  .player.dead { background: #6c757d; text-decoration: line-through; cursor: default; }
  .player.you { border: 2px solid #ffc107; }
  #inputSection { margin-top: 20px; }
  select { padding: 6px 10px; border-radius: 5px; border: none; }
</style>
</head>
<body>
<div id="game">
  <h1>싱글마피아42 텍스트 게임</h1>

  <div id="setup">
    <label>참가 인원 수: 
      <select id="playerCount"></select>
    </label>
    <button id="startBtn">게임 시작</button>
  </div>

  <div id="messages"></div>
  <div id="players"></div>
  <div id="inputSection"></div>
</div>

<!-- 배경음악 -->
<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/02/08/audio_2c0c0c2a3d.mp3?filename=chill-vibes-13902.mp3" loop autoplay></audio>

<script>
  // 플레이어 수 옵션 3~12명
  const playerCountSelect = document.getElementById("playerCount");
  for(let i=3; i<=12; i++) {
    let opt = document.createElement("option");
    opt.value = i; opt.textContent = i + "명";
    playerCountSelect.appendChild(opt);
  }

  const startBtn = document.getElementById("startBtn");
  const messages = document.getElementById("messages");
  const playersDiv = document.getElementById("players");
  const inputSection = document.getElementById("inputSection");

  // 역할 배분 함수
  function rolesByCount(n) {
    let mafiaCount = Math.max(1, Math.floor(n / 4));
    let roles = [];
    roles.push(...Array(mafiaCount).fill("마피아"));
    if (n >= 6) {
      roles.push("의사");
      roles.push("경찰");
    }
    let citizenCount = n - roles.length;
    roles.push(...Array(citizenCount).fill("시민"));
    // 셔플
    for (let i = roles.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }
    return roles;
  }

  let gameState = {};

  function logMessage(text, clear=false) {
    if(clear) messages.textContent = "";
    messages.textContent += text + "\n";
    messages.scrollTop = messages.scrollHeight;
  }

  function renderPlayers() {
    playersDiv.innerHTML = "";
    gameState.players.forEach(p => {
      let div = document.createElement("div");
      div.classList.add("player");
      div.textContent = (p.id + 1) + (p.id === 0 ? " (당신)" : "");
      div.dataset.id = p.id;
      if (p.alive) div.classList.add("alive");
      else div.classList.add("dead");
      if (p.id === 0) div.classList.add("you");
      playersDiv.appendChild(div);
    });
  }

  function getAlive() {
    return gameState.players.filter(p => p.alive);
  }
  function getAliveIds() {
    return getAlive().map(p => p.id);
  }

  // 게임 시작 함수
  function startGame() {
    let n = parseInt(playerCountSelect.value);
    let roles = rolesByCount(n);
    gameState = {
      players: roles.map((r,i) => ({role:r, alive:true, id:i})),
      phase: 'intro',
      dayCount: 0,
      nightCount: 0,
      playerVote: null,
      nightActions: {
        mafiaTarget: null,
        doctorSave: null,
        policeInspect: null,
      },
      policeReports: {}, // 경찰 조사 결과 기록용
    };
    logMessage("게임이 시작되었습니다!", true);
    logMessage("당신은 1번 플레이어입니다. 역할은 비밀입니다.\n");
    renderPlayers();
    setTimeout(() => nextPhase('night'), 2000);
  }

  // 밤 행동 진행 함수
  function nightPhase() {
    gameState.nightCount++;
    logMessage(`\n🌙 밤 ${gameState.nightCount}일차가 시작됩니다.`);

    let player = gameState.players[0];
    inputSection.innerHTML = "";
    gameState.nightActions = { mafiaTarget: null, doctorSave: null, policeInspect: null };

    // 플레이어 역할별 행동 UI
    if (!player.alive) {
      logMessage("당신은 사망하여 밤 행동을 할 수 없습니다.");
      setTimeout(() => aiNightActions(), 1500);
      return;
    }

    if (player.role === "마피아") {
      logMessage("당신은 마피아입니다. 누구를 죽일지 선택하세요.");
      setupTargetSelection("mafiaTarget", false);
    } else if (player.role === "의사") {
      logMessage("당신은 의사입니다. 누구를 살릴지 선택하세요.");
      setupTargetSelection("doctorSave", true);
    } else if (player.role === "경찰") {
      logMessage("당신은 경찰입니다. 누구를 조사할지 선택하세요.");
      setupTargetSelection("policeInspect", false);
    } else {
      logMessage("당신은 시민입니다. 밤에는 할 일이 없습니다.");
      setTimeout(() => aiNightActions(), 2000);
    }
  }

  function setupTargetSelection(actionKey, canSaveSelf) {
    let alivePlayers = getAlive();
    inputSection.innerHTML = "";
    alivePlayers.forEach(p => {
      if (!canSaveSelf && p.id === 0) return; // 의사만 자기 자신 선택 가능
      let btn = document.createElement("button");
      btn.textContent = `${p.id+1}번 플레이어`;
      btn.onclick = () => {
        gameState.nightActions[actionKey] = p.id;
        inputSection.innerHTML = "";
        logMessage(`선택 완료: ${p.id+1}번 플레이어`);
        setTimeout(() => aiNightActions(), 1000);
      };
      inputSection.appendChild(btn);
    });
  }

  // AI 밤 행동 함수
  function aiNightActions() {
    let player = gameState.players[0];
    let alivePlayers = getAlive();

    // 마피아 AI 행동 (마피아 여러명 있을수도)
    if (!gameState.nightActions.mafiaTarget) {
      let mafiaPlayers = gameState.players.filter(p => p.alive && p.role === "마피아" && p.id !== 0);
      if (mafiaPlayers.length > 0) {
        let targets = gameState.players.filter(p => p.alive && p.role !== "마피아");
        if (targets.length > 0) {
          gameState.nightActions.mafiaTarget = targets[Math.floor(Math.random() * targets.length)].id;
          logMessage(`AI 마피아가 ${gameState.nightActions.mafiaTarget+1}번 플레이어를 죽일 후보로 선정했습니다.`);
        }
      }
    }

    // 의사 AI 행동
    if (!gameState.nightActions.doctorSave) {
      let doctors = gameState.players.filter(p => p.alive && p.role === "의사" && p.id !== 0);
      if (doctors.length > 0) {
        let candidates = gameState.players.filter(p => p.alive);
        gameState.nightActions.doctorSave = candidates[Math.floor(Math.random() * candidates.length)].id;
        logMessage(`AI 의사가 ${gameState.nightActions.doctorSave+1}번 플레이어를 치료 후보로 선정했습니다.`);
      }
    }

    // 경찰 AI 행동
    if (!gameState.nightActions.policeInspect) {
      let policePlayers = gameState.players.filter(p => p.alive && p.role === "경찰" && p.id !== 0);
      if (policePlayers.length > 0) {
        let candidates = gameState.players.filter(p => p.alive && p.id !== 0);
        gameState.nightActions.policeInspect = candidates[Math.floor(Math.random() * candidates.length)].id;
        logMessage(`AI 경찰이 ${gameState.nightActions.policeInspect+1}번 플레이어를 조사 후보로 선정했습니다.`);
      }
    }

    setTimeout(() => resolveNightActions(), 2000);
  }

  // 밤 행동 결과 처리
  function resolveNightActions() {
    let mafiaTarget = gameState.nightActions.mafiaTarget;
    let doctorSave = gameState.nightActions.doctorSave;
    let policeInspect = gameState.nightActions.policeInspect;

    if (mafiaTarget !== doctorSave) {
      gameState.players[mafiaTarget].alive = false;
      logMessage(`\n${mafiaTarget + 1}번 플레이어가 밤에 죽었습니다.`);
    } else {
      logMessage(`\n의사가 ${doctorSave + 1}번 플레이어를 치료하여 생존했습니다.`);
    }

    // 경찰 조사 결과 기록
    if (policeInspect !== null) {
      let role = gameState.players[policeInspect].role;
      gameState.policeReports[policeInspect] = role;
      logMessage(`경찰이 ${policeInspect + 1}번 플레이어를 조사했습니다.`);
    }

    renderPlayers();

    if (checkWin()) {
      nextPhase("end");
    } else {
      setTimeout(() => nextPhase("day"), 3000);
    }
  }

  // 낮 진행
  function dayPhase() {
    gameState.dayCount++;
    logMessage(`\n☀ 낮 ${gameState.dayCount}일차가 시작되었습니다.`);
    logMessage("생존자들은 마피아를 찾아내기 위해 투표를 시작합니다.");

    renderPlayers();
    setupVote();
  }

  // 투표 UI 생성
  function setupVote() {
    inputSection.innerHTML = "";
    let player = gameState.players[0];
    if (!player.alive) {
      logMessage("당신은 사망하여 투표에 참여할 수 없습니다. AI들이 투표를 진행합니다.");
      setTimeout(() => aiVoteOnly(), 1500);
      return;
    }
    inputSection.innerHTML = "<p>누구를 처형할까요? (본인 제외)</p>";
    let alivePlayers = getAlive().filter(p => p.id !== 0);
    alivePlayers.forEach(p => {
      let btn = document.createElement("button");
      btn.textContent = `${p.id + 1}번 플레이어`;
      btn.onclick = () => playerVote(p.id);
      inputSection.appendChild(btn);
    });
  }

  // 플레이어 투표 처리
  function playerVote(votedId) {
    gameState.playerVote = votedId;
    inputSection.innerHTML = "";
    logMessage(`당신은 ${votedId + 1}번 플레이어를 투표했습니다.`);

    // AI 투표와 합산 처리
    let votes = {};
    function addVote(id) { votes[id] = (votes[id] || 0) + 1; }
    addVote(votedId); // 플레이어 투표 추가

    let alivePlayers = getAlive().filter(p => p.id !== 0);
    alivePlayers.forEach(p => {
      let candidates = getAlive().filter(x => x.id !== p.id);
      let voteTarget;
      if (p.role === "마피아") {
        let nonMafia = candidates.filter(x => x.role !== "마피아");
        voteTarget = nonMafia.length ? nonMafia[Math.floor(Math.random() * nonMafia.length)] : candidates[Math.floor(Math.random() * candidates.length)];
      } else {
        voteTarget = candidates[Math.floor(Math.random() * candidates.length)];
      }
      addVote(voteTarget.id);
    });

    // 최고 득표자 찾기 및 처형
    let maxVotes = Math.max(...Object.values(votes));
    let candidates = Object.keys(votes).filter(k => votes[k] === maxVotes);
    let executedId = parseInt(candidates[Math.floor(Math.random() * candidates.length)]);

    gameState.players.find(p => p.id === executedId).alive = false;
    logMessage(`\n투표 결과 ${executedId + 1}번 플레이어가 처형되었습니다.`);

    renderPlayers();

    if (checkWin()) {
      nextPhase('end');
    } else {
      setTimeout(() => nextPhase('night'), 2000);
    }
  }

  // AI만 투표 진행 (플레이어 사망시)
  function aiVoteOnly() {
    let votes = {};
    let alivePlayers = getAlive();

    alivePlayers.forEach(p => {
      if (p.id === 0) return;
      let candidates = alivePlayers.filter(x => x.id !== p.id);
      let voteTarget;
      if (p.role === "마피아") {
        let nonMafia = candidates.filter(x => x.role !== "마피아");
        voteTarget = nonMafia.length ? nonMafia[Math.floor(Math.random() * nonMafia.length)] : candidates[Math.floor(Math.random() * candidates.length)];
      } else {
        voteTarget = candidates[Math.floor(Math.random() * candidates.length)];
      }
      votes[voteTarget.id] = (votes[voteTarget.id] || 0) + 1;
    });

    let maxVotes = Math.max(...Object.values(votes));
    let candidates = Object.keys(votes).filter(k => votes[k] === maxVotes);
    let executedId = parseInt(candidates[Math.floor(Math.random() * candidates.length)]);
    gameState.players.find(p => p.id === executedId).alive = false;
    logMessage(`\nAI 투표 결과 ${executedId + 1}번 플레이어가 처형되었습니다.`);
    renderPlayers();

    if (checkWin()) {
      nextPhase('end');
    } else {
      setTimeout(() => nextPhase('night'), 2000);
    }
  }

  // 승리 조건 검사
  function checkWin() {
    let alivePlayers = getAlive();
    let mafiaAlive = alivePlayers.filter(p => p.role === "마피아");
    let citizensAlive = alivePlayers.filter(p => p.role !== "마피아");

    if (mafiaAlive.length === 0) {
      logMessage("\n🎉 시민들이 승리했습니다!");
      return true;
    }
    if (mafiaAlive.length >= citizensAlive.length) {
      logMessage("\n💀 마피아가 승리했습니다!");
      return true;
    }
    return false;
  }

  // 다음 단계로 이동
  function nextPhase
